#!/bin/bash

subject="Notification check on `date +'%Y-%m-%d %H:%M:%S'`"
echo $subject
echo "$subject" | mail -s "$subject" waiting@easilydo.com

sleep 10
total=0
for var in "$@"
do
    echo $var
    cmd="grep '$subject' /var/log/easilydo/push_offline.log"
    echo $cmd
    ret=`echo "$cmd" | ssh web_tools@$var -i /home/easilydo_deploy/.ssh/id_ras_web_tools "bash -s"  | grep "waiting@easilydo.com" | grep "Send payload" | grep "resp: 200" | wc -l`
    echo $ret
    total=$(echo $total + $ret | bc) 
done
echo $total

if [ $total -eq 0 ]
then
    echo "CRIT: Not found send notification for '$subject'"
    exit 2
else
    echo "OK: '$subject'"
    exit 0
fi